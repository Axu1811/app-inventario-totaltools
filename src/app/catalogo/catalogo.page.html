<ion-header class="ion-no-border">
<ion-toolbar class="brand-toolbar">
    <ion-buttons slot="start">
      <ion-button routerLink="/welcome" color="light">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>
      <span class="brand-text">CATÁLOGO <span style="color:#00a8cc">TOTAL</span></span>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button class="cart-btn" (click)="setOpen(true)">
        <ion-icon name="cart-outline"></ion-icon>
        <div class="cart-dot" *ngIf="quoteCart.length > 0">{{ quoteCart.length }}</div>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar class="search-toolbar">
    <ion-searchbar 
      [(ngModel)]="searchTerm" 
      (ionInput)="filterProducts($event)" 
      placeholder="Buscar herramienta..." 
      class="custom-search"
      animated="true">
    </ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-catalogo">
  
  <!-- BANNER -->
  <div class="promo-banner animate__animated animate__fadeIn">
    <div class="promo-content">
      <h3>COTIZA TU <br><span class="cyan-text">EQUIPO</span></h3>
    </div>
    <img 
      src="https://images.unsplash.com/photo-1504148455328-c376907d081c?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
      class="promo-img" 
      alt="Herramienta Total Tools"
      onError="this.style.display='none'"
    >
  </div>

  <div class="section-header ion-padding-horizontal">
    <h4>Productos Disponibles</h4>
    <span class="badge-count">{{ filteredProducts.length }} items</span>
  </div>

  <!-- ESTADOS VACÍOS -->
  <div *ngIf="filteredProducts.length === 0 && allProducts.length > 0" class="empty-state">
    <ion-icon name="search-outline"></ion-icon>
    <p>No encontramos esa herramienta</p>
  </div>
  
  <div *ngIf="allProducts.length === 0" class="empty-state">
    <ion-icon name="hammer-outline"></ion-icon>
    <p>Cargando catálogo...</p>
  </div>

<ion-grid class="ion-no-padding product-grid">
    <ion-row>
      <ion-col size="6" size-md="4" *ngFor="let p of filteredProducts">
        
        <div class="modern-card animate__animated animate__fadeInUp">
          
          <div class="floating-badge" [class.no-stock]="p.stock < 1">
            <ion-icon name="cube-outline" *ngIf="p.stock > 0"></ion-icon>
            <ion-icon name="alert-circle-outline" *ngIf="p.stock < 1"></ion-icon>
            <span>{{ p.stock > 0 ? p.stock : 'Agotado' }}</span>
          </div>

          <div class="card-image-wrapper">
            <img [src]="p.image" onError="this.src='https://via.placeholder.com/150/FFFFFF/CCCCCC?text=Sin+Foto'" alt="{{ p.name }}">
          </div>

          <div class="card-content">
            <span class="sku-pill">{{ p.code }}</span>
            <h3 class="product-title">{{ p.name }}</h3>
            
            <div class="action-footer">
              <div class="price-group">
                <span class="currency">S/.</span>
                <span class="amount">{{ p.price }}</span>
              </div>
              
              <ion-button class="add-btn-circle" [disabled]="p.stock < 1" (click)="addToQuote(p)">
                <ion-icon name="add" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </div>

        </div>

      </ion-col>
    </ion-row>
  </ion-grid>

  <div style="height: 50px"></div>

  <!-- --- MODAL DE COTIZACIÓN REDISEÑADO (MODIFICADO) --- -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="setOpen(false)" [initialBreakpoint]="0.90" [breakpoints]="[0, 0.5, 0.90, 1]" class="cart-modal">
    <ng-template>
      <!-- Cabecera del Modal -->
      <ion-header class="ion-no-border">
        <ion-toolbar color="light">
          <ion-title class="ion-text-center">
            <span class="title-text">Tu Pedido <span class="cyan-text">Total</span></span>
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="setOpen(false)" color="medium">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <!-- Contenido del Carrito -->
      <ion-content class="cart-content ion-padding">
        
        <!-- Carrito Vacío -->
        <div *ngIf="quoteCart.length === 0" class="empty-cart-container">
          <ion-icon name="cart-outline"></ion-icon>
          <h3>Tu lista está vacía</h3>
          <p>Agrega herramientas para cotizar</p>
          <ion-button (click)="setOpen(false)" fill="solid" class="back-shop-btn">IR AL CATÁLOGO</ion-button>
        </div>

        <!-- Lista de Items -->
        <div class="cart-list" *ngIf="quoteCart.length > 0">
          
          <div class="cart-item-card" *ngFor="let item of quoteCart">
            
            <!-- Imagen Pequeña -->
            <div class="item-thumb">
              <img [src]="item.product.image" 
                   onError="this.src='https://via.placeholder.com/50/EEE/666?text=Foto'" 
                   alt="{{ item.product.code }}">
            </div>

            <!-- Info -->
            <div class="item-info">
              <span class="item-sku">{{ item.product.code }}</span>
              <h4 class="item-title">{{ item.product.name }}</h4>
              <span class="item-price">S/. {{ item.product.price }} c/u</span>
            </div>

            <!-- Controles y Borrar -->
            <div class="item-actions">
            <div class="qty-selector">
                <ion-button class="qty-btn minus-btn" (click)="updateQuantity(item, -1)" [disabled]="item.quantity <= 1" fill="clear" size="small">
                  <ion-icon slot="icon-only" name="remove-outline"></ion-icon>
                </ion-button>
                
                <ion-input 
                  type="number" 
                  [(ngModel)]="item.quantity" 
                  (ionBlur)="validateQuantity(item)"
                  class="qty-value ion-text-center"
                  min="1"
                  inputmode="numeric"
                  style="--padding-start:0; --padding-end:0; max-width: 50px;">
                </ion-input>

                <ion-button class="qty-btn plus-btn" (click)="updateQuantity(item, 1)" fill="clear" size="small">
                  <ion-icon slot="icon-only" name="add-outline"></ion-icon>
                </ion-button>
              </div>
              
              <button class="delete-item-btn" (click)="removeFromQuote(item)">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>

          </div>

        </div>

      </ion-content>

      <!-- Footer del Modal con Total y Botón de Acción -->
      <ion-footer *ngIf="quoteCart.length > 0" class="ion-no-border cart-footer">
        <div class="footer-details">
            <div class="total-row">
              <span>Items:</span>
              <strong>{{ quoteCart.length }} productos</strong>
            </div>
            
            <p class="whatsapp-note">
              <ion-icon name="logo-whatsapp"></ion-icon>
              El pedido se enviará al chat de ventas
            </p>
        </div>
        
        <ion-button expand="block" class="final-action-btn" (click)="downloadExcel()">
          <ion-icon name="document-text-outline" slot="start"></ion-icon>
          DESCARGAR & ENVIAR
        </ion-button>
      </ion-footer>
    </ng-template>
  </ion-modal>

</ion-content>