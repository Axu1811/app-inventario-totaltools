<ion-header class="ion-no-border">
  <ion-toolbar class="brand-toolbar">
    <ion-buttons slot="start">
      <!-- CAMBIO AQUÍ: Ahora regresa a 'welcome' (Bienvenida), no al login -->
      <ion-button routerLink="/welcome" color="light">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>
      <span class="brand-text">CATÁLOGO <span style="color:#00a8cc">TOTAL</span></span>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button class="cart-btn" (click)="setOpen(true)">
        <ion-icon name="cart-outline"></ion-icon>
        <div class="cart-dot" *ngIf="quoteCart.length > 0">{{ quoteCart.length }}</div>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar class="search-toolbar">
    <ion-searchbar 
      [(ngModel)]="searchTerm" 
      (ionInput)="filterProducts($event)" 
      placeholder="Buscar código o herramienta..." 
      class="custom-search"
      animated="true">
    </ion-searchbar>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-catalogo">
  
  <!-- BANNER -->
  <div class="promo-banner animate__animated animate__fadeIn">
    <div class="promo-content">
      <h3>COTIZA TU <br><span class="cyan-text">EQUIPO</span></h3>
      <p>Descarga tu pedido en Excel</p>
    </div>
    <!-- Usamos la imagen segura que ya configuramos -->
    <img 
      src="https://carbonestore.com/cdn/shop/products/TIDLI12206_1.png?v=1640191098"
      class="promo-img" 
      alt="Taladro Total Tools"
      onError="this.src='https://via.placeholder.com/150?text=Total+Tools'"
    >
  </div>

  <div class="section-header ion-padding-horizontal">
    <h4>Productos</h4>
    <span class="badge-count">{{ filteredProducts.length }} items</span>
  </div>

  <ion-grid class="ion-no-padding product-grid">
    <ion-row>
      <ion-col size="6" size-md="4" *ngFor="let p of filteredProducts">
        
        <ion-card class="product-card">
          <div class="badges">
            <span class="badge-stock" [class.no-stock]="p.stock < 1">
              {{ p.stock > 0 ? 'Stock: ' + p.stock : 'AGOTADO' }}
            </span>
          </div>

          <div class="card-image">
            <img [src]="p.image" onError="this.src='https://via.placeholder.com/150?text=Sin+Imagen'">
          </div>

          <div class="card-details">
            <div class="meta-row">
              <span class="sku">{{ p.code }}</span>
            </div>

            <h3 class="product-name">{{ p.name }}</h3>
            
            <div class="price-row">
              <span class="price">S/.{{ p.price }}</span>
              <ion-button size="small" class="quote-btn" [disabled]="p.stock < 1" (click)="addToQuote(p)">
                <ion-icon name="add-circle-outline" slot="start"></ion-icon>
                COTIZAR
              </ion-button>
            </div>
          </div>
        </ion-card>

      </ion-col>
    </ion-row>
  </ion-grid>

  <div style="height: 50px"></div>

  <!-- MODAL DE COTIZACIÓN -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="setOpen(false)" [initialBreakpoint]="0.85" [breakpoints]="[0, 0.85, 1]">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Tu Pedido</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="setOpen(false)">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="ion-padding">
        
        <div *ngIf="quoteCart.length === 0" class="empty-cart">
          <ion-icon name="cart-outline"></ion-icon>
          <p>Tu lista de cotización está vacía.</p>
        </div>

        <ion-list *ngIf="quoteCart.length > 0">
          <ion-item *ngFor="let item of quoteCart" lines="full" class="cart-item">
            
            <div class="cart-item-info">
              <h3 class="cart-name">{{ item.product.name }}</h3>
              <p class="cart-sku">Código: {{ item.product.code }}</p>
            </div>

            <!-- CONTROL DE CANTIDAD -->
            <div class="qty-control" slot="end">
              <ion-button fill="clear" size="small" (click)="updateQuantity(item, -1)">
                <ion-icon name="remove-circle-outline"></ion-icon>
              </ion-button>
              
              <span class="qty-number">{{ item.quantity }}</span>
              
              <ion-button fill="clear" size="small" (click)="updateQuantity(item, 1)">
                <ion-icon name="add-circle-outline"></ion-icon>
              </ion-button>
            </div>

            <ion-button fill="clear" color="danger" slot="end" (click)="removeFromQuote(item)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </ion-item>
        </ion-list>

      </ion-content>

      <ion-footer *ngIf="quoteCart.length > 0" class="ion-padding">
        <p class="info-text">
          <ion-icon name="information-circle-outline"></ion-icon>
          Descarga el Excel y adjúntalo en WhatsApp
        </p>
        
        <ion-button expand="block" class="excel-btn" (click)="downloadExcel()">
          <ion-icon name="document-text-outline" slot="start"></ion-icon>
          DESCARGAR EXCEL & ENVIAR
        </ion-button>
      </ion-footer>
    </ng-template>
  </ion-modal>

</ion-content>